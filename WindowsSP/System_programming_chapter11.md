# System Programming Chapter 11 : 쓰레드의 이해
### 1. 프로세스 vs 쓰레드
- 앞선 멀티프로세스의 처리는 하나의 실행 흐름으로 처리했음
- 시대가 흐름에 따라서 한개의 프로그램 안에서 둘 이상의 실행 흐름을 가져야 하는 경우가 생겨왔음
	- 2개의 실행 흐름을 가지기 위해서 한개의 프로그램이 자식 프로세스를 2개 생성하여 처리하는 방식을 생각할 수 있음
		> but 프로세스가 증가하면 프로세스간 context switch가 빈번하게 발생하고 프로그램 실행에 부담이 가중됨
- 2개의 실행 흐름을 가지기 위해서는 어떤 요소들이 필요할까?
	1. 각각의 프로세스 실행을 위한 분리된 코드가 필요함
		> 동일한 code영역에서 공간만 분리해서 사용해도 무방
	1. 각각의 함수 실행에 따른 stack영역이 필요함
		> 관리의 측면에서 분리된 공간에서 담을 필요가 있음
		>> stack의 특성 상 서로 다른 프로세스의 데이터를 한 공간에서 관리하기 어려움
- Code / Data / Heap 영역은 공유해도 무방, Stack은 공유할 시 번거로움
- 2개의 실행 흐름을 효율적으로 가져가기 위해서 2개의 쓰레드가 부모 프로세스의 Code, Data, Heap을 공유하고 분리된 Stack을 가짐
	> 분리된 동작을 수행하므로 Code영역 내부적으로는 분리된 함수를 가짐
	>> 즉, main의 역할을 수행하는 함수가 2개 이상이라는 의미(main이 곧 실행 흐름을 관장하므로)
	>>> 공유된 영역에서는 메인 프로세스와 각 쓰레드 모두 리소스에 동일하게 접근가능(완전히 분리된 프로세스 간에는 불가능)
	>>>> 멀티 쓰레드는 분리된 멀티 프로세스 간의 통신을 위한 IPC기법이 불필요하다는 의미
### 2. Windows에서의 프로세스와 쓰레드
- Windows관점에서 스케줄러는 사실 프로세스가 아니 쓰레드를 관리
	- 상태정보 역시 프로세스가 아닌 쓰레드의 상태정보를 담고 있음
		> 앞선 프로세스에 적용했던 우선순위 기법 등은 모두 쓰레드에 동일하게 적용하면 됨
	- 실행흐름의 주체는 곧 쓰레드라고 인지해야 함
	- 프로세스와 쓰레드의 경계가 모호하다고 판단될 수 있음
		- 프로세스는 쓰레드가 동작하기 위한 환경을 제공해주고 그 안에서 쓰레드가 동작하게 됨
### 3. 커널 레벨 쓰레드와 유저 레벨 쓰레드
- 커널 레벨 쓰레드 : 커널에서 자체적으로 쓰레드를 지원함
	> 스케줄러가 쓰레드에 대한 정보를 가지고 있고 각각에 대해 직접 관리
	>> - 모든 쓰레드가 대등하게 시간을 할당받아 실행됨  
	>> - 프로세스 내부 한개의 쓰레드가 I/O등의 처리로 block상태로 넘어가더라도 스케줄러는 쓰레드 단위로 관리하므로 동일 프로세서 내 다른 쓰레드로 우선권을 넘겨줄 수 있음
- 유저 레벨 쓰레드 : 커널에서 쓰레드를 지원하지 않고, 유저(개발자)가 자체적으로 library를 통해 쓰레드 사용
	> 스케줄러 입장에서는 오직 프로세스에 대한 정보를 가지고 프로세스를 관리 그 위에서 유저가 쓰레드를 돌림
	>> - 프로세스 간 대등하게 시간을 할당받으나, 프로세스 내부적으로 동작하는 쓰레드의 수에 따라 동작시간을 분배(쓰레드 간 동일한 시간을 할당받지 못할 수 있음)  
	>> - 프로세스 내부에 한개의 쓰레드가 I/O처리 등으로 block상태로 넘어갈시 스케줄러는 프로세서 단위로 인식하기 때문에 다른 프로세스로 우선권을 넘겨버림
### 4. 커널 모드와 유저 모드
- 32bit 기준 프로세스를 생성하게 되면 4G메모리 공간에서 2G는 OS 사용공간, 2G는 application 사용공간으로 할당되어짐
	> 2G 내부에 코드들은 일부 매핑되고, 나머지는 실행되는 공간으로 활용되어 짐
- 4G메모리 영역을 분리해서 사용하므로 유저영역에서 커널영역으로 접근할 가능성도 있음
	> 이에 대한 해결책으로 유저 모드, 커널 모드로 분리하여 유저영역이 커널영역으로 접근하지 못하도록 제한함
	>> 스케줄러가 동작할때, 프로세스 생성할 때 등 커널단에서 동작할때는 커널 모드로 동작함
- 위와 같은 이유로 커널 레벨 쓰레드의 경우 각 쓰레드에 대한 관리를 커널모드에서 수행해야 함으로 프로세스만 관리때만 커널모드로 진입하는 유저 레벨 쓰레드에 비해서 속도가 느리다
- 장점과 단점
	- 커널 레벨 쓰레드의 장점 및 단점
		- 장점 : 커널에서 직접 제공해 주기 때문에 안정선과 다양한 기능성 제공
		- 단점 : 유저 모드에서 커널 모드로의 전환이 빈번
	- 유저 레벨 쓰레드의 장점 및 단점
		- 장점 : 유저 모드에서 커널 모드로의 전환이 필요 없다
		- 단점 : 프로세스 단위 블로킹
