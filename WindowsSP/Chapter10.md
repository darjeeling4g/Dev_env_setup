# System Programming Chapter 10 : 컴퓨터 구조에 대한 세 번째 이야기
### 1. 절차적 함수 호출(Procedure Call) 지원 CPU모델
- 스택 프레임(Stack Frame)이란?
	> 임의의 함수 내에서 선언된 메모리 공간
	- 어떻게 각 데이터들이 겹치지 않고 순차적으로 쌓일 수 있을까? `sp 레지스터`
- sp 레지스터
	- 메모리 주소를 시작부터 순차적으로 올려가며 stack공간 데이터들이 겹치지 않고 순차적으로 쌓일 수 있도록 함
	- 중간에 종료된 함수의 스택 프레임을 반환하려면 돌아올 위치를 기억해야 가능함, 이를 담당하는 것은? `fp 레지스터`
- fp 레지스터
	- sp 레지스터의 백업 레지스터
		- 특정 함수의 호출과 동시에 해당위치를 담고 있음
		- 함수가 종료되어 반환되면 sp가 다시 원래 위치로 내려가게 됨
			> 다시 함수호출 이전위치로 돌아오면 함수가 실행되면서 저장한 데이터들이 위에 존재하지만 순차적으로 덮어쓸 것이기 때문에 반환한 것과 사실상 동일하다
- fp 레지스터 문제점
	- 함수가 반환되기 이전에 호출이 계속 반복될 경우 이전 값이 계속 덮어써지게 됨 --> 즉, 원래위치를 잃어버림
	- 이를 해결하기 위해서 fp 레지스터 역시 백업이 필요함
		> 백업될 수량이 무한정으로 늘어날 수 있기 때문에 백업을 레지스터가 아닌 메모리로 함
- fp 레지스터 해결책
	- 백업을 메모리에 하기위해 스택을 이용하는 방법을 채택
		- fp에 담겨있는 정보를 현재 sp의 위치에 저장하고 sp의 백업을 진행함 이후 데이터는 sp+1 번 위치부터 쌓여나감
		- 중간에 함수가 반환되면 돌아갈 곳의 정보를 sp에 전달하고 그 위치에 저장되어 있는 데이터(이전 함수 호출지점)을 다시 fp에 담게 됨
			> 위의 방법으로 함수가 반복적으로 호출되더라도 역순으로 반환해 나갈 수 있게됨
### 2. 함수 호출 인자의 전달과 PUSH & POP 명령어 디자인
- 함수 호출 인자의 전달방식
	```c
	function(7, 8)
	// 위처럼 인자를 넘겼을 경우
	```
	- sp가 가리키는 현재 위치에 전달되는 인자값을 저장하고 나서, sp를 증가시켜 다음 메모리 주소를 가리키게 한다
		> 즉, 2가지 동작 수행 : 인자값 저장, sp 증가
- 함수 호출 인자의 전달방식(문제점은?)
	```assembly
	STORE	7,	sp
	; 아래 형식을 지켜야 하기 때문에 위와 같이 작성할 수 없음

	STORE	대상(레지스터),	목적지(메모리 주소)
	; 따라서 7을 별도의 r1레지스터에 담고, sp의 값을 메모리에 담아 해당 메모리 주소로 작성해서 해결
	```
	1. 7을 r1 레지스터에 저장하는 동작
	1. sp의 값을 메모리에 저장하는 동작
	1. 최종적으로 STORE하는 명령
		>  3번의 작업이 필요해짐
- 문제점 해결 **(PUSH 명령어 완성)**
	```assembly
	ADD	r1,	7,	0	;별도 레지스터 값을 저장하는 명령어가 없으므로 ADD를 통해 값을 넣어줌
	STORE	sp,	0x40
	STORE	r1,	[0x40]		;주소 값을 넘겨야 하므로 indirect mode사용
	ADD	sp,	sp,	4	;sp의 값 증가
	```
- POP의 기능
	```assembly
	ADD	sp,	sp,	-4

	or

	SUB	sp,	sp,	4
	```
### 3. 호출 규약과 실행의 이동
- 함수호출에 의한 실행의 이동과 pc
	- pc의 역할 : CPU는 pc가 가르키는 명령어를 다음에 수행함
	- 함수호출은 곧 pc의 값을 변경하는 행위
		> 서브 함수로 실행의 이동
	- pc의 백업을 담당하는 것이 LR
		> sp와 fp의 관계와 유사하다
- 함수호출 규약
	- 파라미터를 어느방향 순서대로 쌓을 것인가?
	- 함수 반환에 대한 처리를 Caller, function 어디에서 처리할 것인가?
	- 매개변수를 저장하는 레지스터는 무엇으로 할 것인가? 몇 개를 사용할 것인가?
		> 매개변수는 무조건 스택에 저장되는 것이 아니라 속도향상을 위해 일부는 레지스터에 저장되어 처리하도록 함
		>> 32bit에서는 제한적이었으나, 64bit 시스템에서는 레지스터를 반드시 사용함
	- 위의 사항등에 대해서 어긋나지 않도록 하는 통일된 약속이 함수호출 규약
